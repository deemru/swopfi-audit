# Swop.fi аудит

## Область исследования

Исследуется проект Swop.fi по состоянию до 13 мая 2021 года включительно.

Объектом исследования является комплексная работа смарт-контрактов проекта в основной сети Waves.

На момент исследования, проект представляет собой экосистему состоящую из 22 смарт-контрактов. Внешней зависимостью данной экосистемы является функционал стейкинга токенов USDN, EURN и NSBT.

Так как функционал стейкинга является частью работы [протокола Neutrino](https://neutrino.at), стейкинг не является объектом полноценного аудита, учёт и распределение начислений считаются зоной ответственности [протокола Neutrino](https://neutrino.at).

## Состав проекта

Состав проекта определяется по открытой информации представленной на официальном сайте [swop.fi](https://swop.fi). Далее анализируется вывод работы скрипта [`test-addresses`](test/test-addresses.php), который находит использованные в контрактах адреса. После определения всех участвующих в проекте адресов производится анализ установленных на данные адреса контрактов.

Итоговый набор контрактов:

```php
$contracts = [
    ['pool-cpmm',       '3P8FVZgAJUAq32UEZtTw84qS4zLqEREiEiP'], // WAVES/BTC
    ['pool-cpmm',       '3PHaNgomBkrvEL2QnuJarQVJa71wjw9qiqG'], // WAVES/USDN
    ['pool-cpmm-eurn',  '3PK7Xe5BiedRyxHLuMQx5ey9riUQqvUths2'], // WAVES/EURN
    ['pool-cpmm',       '3P27S9V36kw2McjWRZ37AxTx8iwkd7HXw6W'], // SWOP/USDN
    ['pool-flat',       '3PPH7x7iqobW5ziyiRCic19rQqKr6nPYaK1'], // USDT/USDN
    ['pool-flat',       '3PNi1BJendWYYe2CRnqpfLoYxUZ6UTcx3LF'], // USDC/USDN
    ['pool-cpmm',       '3PDWi8hjQJjXhyTpeaiEYfFKWBd1iC4udfF'], // USDLP/USDN
    ['pool-cpmm',       '3PNr615DPhHpCJSq1atHYKKnoauWGHsYWBP'], // USDCLP/USDN
    ['pool-cpmm',       '3PACj2DLTw3uUhsUmT98zHU5M4hPufbHKav'], // BTC/USDN
    ['pool-cpmm-nsbt',  '3P2V63Xd6BviDkeMzxhUw2SJyojByRz8a8m'], // NSBT/USDN
    ['pool-cpmm',       '3PNEC4YKqZiMMytFrYRVtpW2ujvi3aGXRPm'], // ETH/USDN
    ['pool-cpmm',       '3P6DLdJTP2EySq9MFdJu6beUevrQd2sVVBh'], // WEST/USDN
    ['pool-cpmm',       '3PMDFxmG9uXAbuQgiNogZCBQASvCHt1Mdar'], // WCT/USDN
    ['pool-cpmm',       '3P9o2H6G5d2xXBTfBEwjzHc16RLSZLFLQjp'], // CRV/USDN
    ['pool-cpmm',       '3P4Ftyud3U3xnuR8sTc1RvV4iQD62TcKndy'], // SIGN/USDN
    ['pool-cpmm',       '3PKy2mZqnvT2EtpwDim9Mgs6YvCRe4s85nX'], // FL/USDN

    ['early-birds',     '3PJuspTjxHhEJQjMEmLM5upiGQYCtCi5LyD'],
    ['governance-lp',   '3P6J84oH51DzY6xk2mT5TheXRbrCwBMxonp'],
    ['governance',      '3PLHVWCqA9DJPDbadUofTohnCULLauiDWhS'],
    ['farming',         '3P73HDkPqG15nLXevjCbmXtazHYTZbpPoPw'],
    ['voting',          '3PQZWxShKGRgBN1qoJw6B4s9YWS9FneZTPg'],
    ['pools',           '3PEbqViERCoKnmcSULh6n2aiMvUdSQdCsom'],
];
```

Разбор смарт-контрактов происходит в автоматическом режиме скриптом [test-contracts](test/test-contracts.php). Данный скрипт находит последнюю транзакцию установки смарт-контракта, декомпилирует смарт-контракт средствами ноды Waves и записывает данную информацию в файл. Имя файла содержит префикс, который является контрольной суммой кода декомпилированного контракта.

По полученным данным смарт-контракты можно представить как:

- 16 обменных пулов:
  - 12 CPMM со стейкингом USDN
  - 2 FLAT со стейкингом USDN
  - 1 CPMM со стейкингом EURN
  - 1 CPMM с двойным стейкингом NSBT и USDN
- Early-birds (распределение SWOP для ранних инвесторов)
- Governance (распределение SWOP за стейкинг)
- Governance-LP (сбор и конвертация комиссий в SWOP для Governance)
- Farming (награда за стейкинг токенов обменных пулов)
- Pools (реестр пулов)
- Voting (голосование)

Результат декомпиляции языка RIDE представляет близкий к исходному код, с сохранением имён функций и переменных. Для анализа контрактов в целом достаточно иметь декомпилированную версию кода. Однако, такие элементы как например раскрывающиеся вызовы [FOLD](https://docs.waves.tech/en/ride/fold-macro), могут затруднить анализ, поэтому желательно иметь соответствующий контрактам исходный код.

Исходный код, представленный в репозитории [swopfi/swopfi-smart-contracts](https://github.com/swopfi/swopfi-smart-contracts), не позволяет установить однозначное соответствие исходного и декомпилированного кода без дополнительного анализа, что затрудняет аудит.

РЕКОМЕНДУЕТСЯ вести проверяемый учёт версий исходного кода, который непосредственно устанавливается в качестве смарт-контрактов.

Для установки соответствия исходным кодам используется опция `WGIT` в [test-contracts](test/test-contracts.php). С помощью данной опции и сравнения контрактов между собой получены следующие соответствия:

- Пулы CPMM: [`0024b99ca77bb89544405043b434455e8d06125f`: other_cpmm.ride](https://raw.githubusercontent.com/swopfi/swopfi-smart-contracts/0024b99ca77bb89544405043b434455e8d06125f/dApps/other_cpmm.ride)
- Пулы FLAT: [`b1149700ac09b0f346537187adc31a27f19db0f4`: flat.ride](https://raw.githubusercontent.com/swopfi/swopfi-smart-contracts/b1149700ac09b0f346537187adc31a27f19db0f4/dApps/flat.ride)
- Пул CPMM (EURN): [`6d25e6255f2c468118fae4fa4dd89677c25adfbc`: waves_eurn.ride](https://raw.githubusercontent.com/swopfi/swopfi-smart-contracts/6d25e6255f2c468118fae4fa4dd89677c25adfbc/dApps/waves_eurn.ride)
- Early-birds: [`0b41ebdc18f31e6cbe3ad3e7e60993e2f6d9b4b6`: earlybirds.ride](https://raw.githubusercontent.com/swopfi/swopfi-smart-contracts/0b41ebdc18f31e6cbe3ad3e7e60993e2f6d9b4b6/dApps/SWOP/earlybirds.ride)
- Governance: [`a68796c2073c623b0d1d6f7185f52ec75be9a7fa`: governance.ride](https://raw.githubusercontent.com/swopfi/swopfi-smart-contracts/a68796c2073c623b0d1d6f7185f52ec75be9a7fa/dApps/SWOP/governance.ride)
- Governance-LP: [`452881ecc97dc689a4fad92ca91e147c28f6eb93`: wallet_verifier.ride](https://raw.githubusercontent.com/swopfi/swopfi-smart-contracts/452881ecc97dc689a4fad92ca91e147c28f6eb93/dApps/SWOP/wallet_verifier.ride)
- Farming: [`452881ecc97dc689a4fad92ca91e147c28f6eb93`: farming.ride](https://raw.githubusercontent.com/swopfi/swopfi-smart-contracts/452881ecc97dc689a4fad92ca91e147c28f6eb93/dApps/SWOP/farming.ride)
- Pools: [`924f1ed9b4c902bbfa96494e4067c4d7b17ff36d`: oracle.ride](https://raw.githubusercontent.com/swopfi/swopfi-smart-contracts/924f1ed9b4c902bbfa96494e4067c4d7b17ff36d/dApps/SWOP/oracle.ride)
- Voting: [`a68796c2073c623b0d1d6f7185f52ec75be9a7fa`: voting.ride](https://raw.githubusercontent.com/swopfi/swopfi-smart-contracts/a68796c2073c623b0d1d6f7185f52ec75be9a7fa/dApps/SWOP/voting.ride)

## Безопасность

### Общее

Рассматриваются смарт-контракты Swop.fi, с точки зрения сохранности пользовательских средств в общем виде, безотносительно функционала внутреннего перерасчёта.

Ведение балансов происходит в [хранилищах данных аккаунтов](https://docs.waves.tech/en/blockchain/account/account-data-storage) смарт-контрактов, у каждого смарт-контракта своё непересекающееся с другими хранилище, оно может быть представлено как база данных на парах ключ/значение. При этом ключи состоят из адреса пула, адреса пользователя и фиксированной строки, что равносильно типичному хранению токенов в блокчейне, где ключ в базе данных можно представить как адрес пользователя плюс идентификатор токена. При этом значением в обоих случаях будет баланс токенов.

Идентификатор токенов однозначно определяется логикой и не меняется в процессе работы.

Адрес пользователя определяется по адресу отправителя пользовательской транзакции, что гарантирует прохождение [всех проверок, связанных с аккаунтом пользователя](https://docs.waves.tech/en/ride/functions/verifier-function) (например, дополнительных к проверке подписи по умолчанию действий, в соответствии со смарт-аккаунтом пользователя, при наличии).

В контрактах отсутствует функциональность внешнего отрицательного влияния на записи в пользовательских данных, за исключением действий самого пользователя, например при выводе средств.

Также в контрактах отсутствует функциональность смены владельца записи, что однозначно фиксирует вывод только за адресом, осуществившим ввод. Поэтому наиболее близким аналогом ведения учёта в контрактах Swop.fi является нативная работа лизинга, транзакций [Lease](https://docs.waves.tech/en/blockchain/transaction-type/lease-transaction) и [Lease Cancel](https://docs.waves.tech/en/blockchain/transaction-type/lease-cancel-transaction).

Так как разделителем смысловых частей ключа при доступе к значению является символ `_`, а также смысловые постфиксы к ключам содержат символы `_`, НЕ РЕКОМЕНДУЕТСЯ использовать символ разделителя в прочих частях ключа, так как при дальнейшем расширении функционала существует возможность обращения к ключу, отличному от смысла.

### Администрирование

Автоматизированный анализ контрактов на наличие публичных ключей проводится скриптом [test-admins](test/test-admins.php). Данный скрипт находит последнюю транзакцию установки смарт-контракта, декомпилирует смарт-контракт средствами ноды Waves и находит все используемые записи переменных, соответствующие открытым ключам и выводит сводную информацию на экран.

Во всех контрактах используется переопределённая [функция Verifier](https://docs.waves.tech/en/ride/functions/verifier-function), которая обеспечивает повышенную безопасность при администрировании контрактов. Данная функция требует наличия 2 подписей администраторов из 3 возможных при обновлении смарт-контракта. 3 публичных ключа администратора зафиксированы в коде каждого смарт-контракта. Таким образом, при компрометации 2 ключей администраторов, проект может полностью лишиться контроля.

РЕКОМЕНДУЕТСЯ улучшить [систему управления ключами](https://en.wikipedia.org/wiki/Key_management) и вынести её в отдельный смарт-контракт.

Автоматизированный анализ показывает, что 2 адреса из 3 соответствующих публичным ключам администраторов имеют исходящие транзакции в основной сети Waves. РЕКОМЕНДУЕТСЯ использовать ключи администраторов исключительно для администрирования в целях минимизации риска [атаки по побочным каналам](https://en.wikipedia.org/wiki/Side-channel_attack).

Также в коде контрактов зафиксированы вспомогательные публичные ключи, которым разрешено от имени соответствующих им адресов производить определённые действия, такие как запуск и остановка контракта, работа функций стейкинга и другие, не требующие повышенных привилегий. Данный ограниченный функционал подробно зафиксирован для каждого контракта, однако такие поля как `fee` и `feeAssetId` не проверяются. РЕКОМЕНДУЕТСЯ добавить соответствующие проверки для исключения манипуляций размером комиссии.

В контракте [`farming.ride`](https://github.com/swopfi/swopfi-smart-contracts/commit/452881ecc97dc689a4fad92ca91e147c28f6eb93#diff-6ccb5b9241c7ad143dd5a8adc495c3e869251c186fdf2cb20db08f53677801e8) применяется изменённая схема разрешения вспомогательных функций, в которой вместо публичных ключей используются адреса. РЕКОМЕНДУЕТСЯ использовать унифицированную схему разрешения, разные подходы с одним и тем же смыслом усложняют систему.

На текущий момент не обнаружено централизованное место с учётом действий администраторов и описанием причин данных действий. Хотя всё в блокчейне является открытыми и проверяемым, РЕКОМЕНДУЕТСЯ вести публичный учёт действий администраторов, например в репозитории с исходным кодом, для облегчения анализа и верификации действий независимыми экспертами.

## Функционал и верификация

Анализ функционала включает в себя аналитический разбор всех функций контракта во всех режимах работы, построение логических зависимостей с другими контрактами, анализ работы на граничных условиях, анализ разрешений на вызов функций.

При анализе функционала проверяется соответствие заявленной и запрограммированной логике.

Верификация функционала смарт-контракта заключается в сравнении нескольких значений, полученных по возможности разными способами при независимой эмуляции функционала на данных работы контрактов в основной сети Waves.

Для целевого контракта процесс происходит следующим образом:

- Загружаются транзакции для адреса контракта и всех вспомогательных адресов, данные которых требуются для корректной работы контракта.
- Транзакции воспроизводятся в коде скрипта, соответствующего функциональной логике контракта.
- На финальном состоянии производится расчёт целевых значений.
- Верификация считается успешной если расчёт совпадает с ожиданием.

### Пулы CPMM

Рассматриваются все пулы с префиксом `pool-cpmm` из таблицы состава проекта, так как общая существенная часть в данных контрактах не имеет отличий.

Контракты определяют функции `init`, `replenishWithTwoTokens`, `withdraw`, `exchange`, `shutdown`, `activate` и `takeIntoAccountExtraFunds`.

Функция проверки исходящих транзакций `verify` немного отличается в трёх версиях контрактов, например требуется подпись одного из администраторов, а для контракта c NSBT только `adminPubKeyStaking`. РЕКОМЕНДУЕТСЯ унифицировать данную логику в следующих версиях, так как её смысл не отличается.

Разрешается собственный вызов `takeIntoAccountExtraFunds`, разрешаются взаимодействия с протоколом Neutrino в рамках стейкинга, а для контракта с NSBT дополнительно разрешён вызов `exchange` в контракте `3PHaNgomBkrvEL2QnuJarQVJa71wjw9qiqG` для обмена поступивших наград в Waves на учитываемые в рамках контракта USDN.

Сама функция `takeIntoAccountExtraFunds` при вызове получает аргумент являющийся количеством токенов, которые используются в качестве комиссии за постановку/снятие со стейкинга протокола Neutrino и должны остаться неучтёнными в балансах токенов пула, так как будут использованы для вызова функций стейкинга.

Расчёт балансов учитывает полный баланс аккаунта в блокчейне и баланс средств в стейкинге. Таким образом, все поступившие средства безотносительно причины их происхождения в общем виде будут идти в плюс пула.

Функции `shutdown` и `activate` могут быть вызваны одним из администраторов и отвечают за приостановку вызова остальных функций и их активацию соответственно. Приостановка контракта означает полную заморозку логики контракта без каких-либо действий со средствами на контракте.

Функция `init` без аргументов инициализирует работу контракта. Аргументами инициализации по сути являются платежи в рамках вызова функции. При этом порядок токенов напрямую не влияет на функционал, но для пользователей удобнее, чтобы пары совпадали с общим порядком, принятым на биржах. От имён токенов берутся до 7 первых символов, добавляется префикс `s`, а строки объединяются разделителем `_`, результирующая строка считается именем долевого токена пула, который выпускается в рамках инициализации.

Количество десятичных знаков определяется средним значением у соответствующих токенов из платежей. Количество начальных долевых токенов вычисляется по формуле перемножения корней от значений начальных платежей и деления произведения на 10 в степени количества десятичных знаков, вычисленного ранее.

[`0024b99ca77bb89544405043b434455e8d06125f`: other_cpmm.ride#L122-L127](https://github.com/swopfi/swopfi-smart-contracts/blob/0024b99ca77bb89544405043b434455e8d06125f/dApps/other_cpmm.ride#L122-L127):

```scala
        let shareDecimals = (pmtDecimalsA + pmtDecimalsB) / 2
        let shareInitialSupply = fraction(
            pow(pmtAmountA, pmtDecimalsA, 5, 1, pmtDecimalsA, HALFDOWN),
            pow(pmtAmountB, pmtDecimalsB, 5, 1, pmtDecimalsB, HALFDOWN),
            pow(10, 0, shareDecimals, 0, 0, HALFDOWN)
        )
```

Принципиального влияния данной формулы расчёта на дальнейший функционал не обнаружено, так как количество токенов далее используется исключительно с долевой точки зрения относительно общего количества. Поэтому достаточно иметь точность соответствующую начальным токенам, что отражается в формуле расчёта десятичных знаков.

Функция `exchange` может быть вызвана любым пользователем блокчейна, принимает на вход в качестве платежа один из токенов, использованных при инициализации, и минимальное значение, которое соответствует минимальному ожидаемому количеству токенов, которое должно быть получено пользователем в обмен. При выполнении всех условий возвращает пользователю другой использованный при инициализации токен в количестве, соответствующем формуле CPMM между токенами, с удержанием комиссии `commission` (0.3%) в пользу пула. Часть данной комиссии также отправляется на контракт Governance-LP (0.12%).

Последней проверкой является достаточность токенов на балансе в настоящий момент, для передачи их пользователю. Так как функционал пулов предполагает активное использование стейкинга протокола Neutrino, достаточное количество токенов может не оказаться на балансе контракта и они должны быть предварительно сняты со стейкинга протокола Neutrino.

Функция разбита на две части, для обмена первого токена на второй и наоборот, что безосновательно дублирует код. РЕКОМЕНДУЕТСЯ объединить смысловые части, так как суть отличия составляет только направление обмена.

Текущие отличия 3 контрактов (`other_cpmm.ride`, `nsbt_usdn.ride` и `waves_eurn.ride`) заключаются только в расчётах и разрешениях, связанных со стейкингом. РЕКОМЕНДУЕТСЯ объединить код CPMM контрактов, несмотря на то, что не весь функционал будет использоваться во всех пулах.

Функции `replenishWithTwoTokens` и `withdraw` вызываются пользователями, которые хотят стать или являются соответственно долевыми участниками пула.

Для получения токенов в функции `replenishWithTwoTokens` необходимо предоставить в качестве платежа токены, использованные при инициализации пула, в том же порядке. Их отношение долей в пуле не должны отличаться более чем `slippageTolerance`, задаваемый пользователем в аргументе функции и принимающий значения больше 0 и меньше максимального `slippageToleranceDelimiter`.

Также в функции учитывается комиссия за стейкинг, если среди токенов имеется USDN, NSBT или EURN. Данная комиссия вычитается из платежа пользователя перед расчётом его доли.

При прохождении всех проверок пользователь получает долевые токены в объёме от минимальной доли из двух токенов пула к общей массе долевых токенов.

Функция `withdraw` выполняет обратную операцию, долевые токены меняются на токены пула в объёме равном доле долевых токенов пользователя в операции от общей доли долевых токенов пула к объёму каждого токена в пуле.

[`0024b99ca77bb89544405043b434455e8d06125f`: other_cpmm.ride (L190-L194)](https://github.com/swopfi/swopfi-smart-contracts/blob/0024b99ca77bb89544405043b434455e8d06125f/dApps/other_cpmm.ride#L190-L194):

```scala
    let (pmtAmount, pmtAssetId) = (i.payments[0].amount, i.payments[0].assetId)

    # block for accounting the cost of commissions for staking operations
    let amountToPayA = pmtAmount.fraction(balanceA, shareAssetSupply).deductStakingFee(assetIdA)
    let amountToPayB = pmtAmount.fraction(balanceB, shareAssetSupply).deductStakingFee(assetIdB)
```

Также в функции учитывается комиссия за стейкинг, если среди токенов имеется USDN, NSBT или EURN. Данная комиссия вычитается из выплаты пользователю после расчёта доли его токенов.

Замечено, что функция `withdraw` в варианте `other_cpmm.ride` не возвращает долевые токены обратно пользователю в случае ошибки на этапе `hasEnoughBalance`. РЕКОМЕНДУЕТСЯ исправить данное поведение или воспользоваться рекомендацией выше про объединение контрактов в общий вид.

Верификация CPMM пулов представлена скриптом [`test-cpmm`](test/test-cpmm.php). Так как работа контракта локализована и никакие дополнительные учёты не ведутся, верификация заключается в проверке рассчитанного состояния состоянию в основной сети Waves.

Верификация проходит успешно, погрешности и отрицательные влияния округлений не обнаружены. Функция `takeIntoAccountExtraFunds` вызывается внешним обработчиком с устоявшимся значением 18 размеров minSponsoredFee, средняя частота вызовов равна раз в ~1456 блоков (~раз в день).

### Пулы FLAT

Рассматриваются все пулы с префиксом `pool-flat` из таблицы состава проекта, соответствуют контракту `flat.ride`.

Контракты по аналогии с пулами CPMM определяют функции `init`, `replenishWithTwoTokens`, `withdraw`, `exchange`, `shutdown`, `activate` и `takeIntoAccountExtraFunds`.

Отличия от CPMM заключаются: 1) в наличии функции `replenishWithOneToken`, которая в отличие от `replenishWithTwoTokens` способна выпустить долевые токены на основе одного токена в платеже, 2) в присутствии дополнительного аргумента `estimatedAmountToReceive` в функции `exchange` и 3) более сложной [формуле расчёта FLAT](https://medium.com/swop-fi/%D1%84%D0%BE%D1%80%D0%BC%D1%83%D0%BB%D1%8B-%D1%80%D0%B0%D1%81%D1%87%D0%B5%D1%82%D0%B0-%D1%86%D0%B5%D0%BD%D1%8B-%D0%B2-%D0%BF%D1%83%D0%BB%D0%B0%D1%85-swop-fi-e0e1416c6d59).

[`b1149700ac09b0f346537187adc31a27f19db0f4`: flat.ride (L101-L112)](https://github.com/swopfi/swopfi-smart-contracts/blob/b1149700ac09b0f346537187adc31a27f19db0f4/dApps/flat.ride#L101-L112):

```scala
func invariantCalc(x: Int, y: Int) = {
    let sk = skewness(x, y)
    fraction(
        x + y,
        scaleValue8,
        pow(sk, scaleValue8Digits, alpha, alphaDigits, scaleValue8Digits, UP)
    ) + 2 * fraction(
        pow(fraction(x, y, scaleValue8), 0, 5, 1, scaleValue8Digits / 2, DOWN),
        pow(sk - beta, scaleValue8Digits, alpha, alphaDigits, scaleValue8Digits, DOWN),
        scaleValue8
    )
}
```

Замечено, что в формуле расчёта инварианта `invariantCalc` используется функция взятия квадратного корня произведения общих балансов токенов пулов, данное произведение возвращается в 64-битное значение, что вызывает [целочисленное переполнение](https://en.wikipedia.org/wiki/Integer_overflow) при балансах каждого из токенов чуть более 30 миллионов.

От команды Swop.fi получено подтверждение, что с выходом новой версии RIDE, данный расчёт будет использовать 512-битную точность целых чисел.

Так как принципиальных отличий от CPMM в остальных функциях не обнаружено, далее рассматриваются только функции `exchange` и `replenishWithOneToken`.

Функция `exchange` может быть вызвана любым пользователем блокчейна, принимает на вход в качестве платежа один из токенов, использованных при инициализации контракта функцией `init`, в качестве аргументов подаются `estimatedAmountToReceive` — ожидаемое количество токенов и `minAmountToReceive` — минимальное. При выполнении всех условий возвращает пользователю другой использованный при инициализации токен в количестве, соответствующем формуле FLAT между токенами, с удержанием комиссии `commission` (0.05%) в пользу пула. Часть данной комиссии также отправляется на контракт Governance-LP (0.02%).

Если значение `estimatedAmountToReceive` не является корректным, то контракт делает ещё 5 дополнительных попыток между ожидаемым и минимальным `minAmountToReceive` значениями, если одно из них оказывается верным, то оно будет считаться суммой обменных токенов.

Замечено, что, если получить ожидаемое количество токенов не является возможным, в расчёте промежуточного результата происходит удержание комиссии, что повторно происходит далее при выходе из функции. Таким образом удерживается двойная комиссия. В актуальном контракте репозитория данное место исправлено, комиссия удерживается однократно, но на момент проведения аудита, данная ошибка так и не была исправлена (обновление 26 мая 2021: ошибка полностью исправлена в коде и установленных контрактах).

Минимальный платеж, с которым может быть произведён обмен, зафиксирован в контракте числом 10000000, что направлено на исключение флуктуаций в формуле расчёта FLAT при малых значения величины обмена.

Замечено, что первая проверка аргументов на попадание итогового значения обмена в границы от `exchangeRatioLimitMin` до `exchangeRatioLimitMax` относительно платежа может быть улучшена, так как `minAmountToReceive` логически более связан с `estimatedAmountToReceive`, чем с `pmtAmount`, а поэтому должен проверяться относительно него. Вариант данного улучшения передан команде Swop.fi.

В функциях `exchange` и `replenishWithOneToken` проверяется, что итоговый баланс одного из токенов контракта не превышает баланс другого более чем в 3 раза.

Для получения долевых токенов пула в функции `replenishWithOneToken` необходимо предоставить в качестве платежа один из токенов пула и аргументы, которые определяют параметры внутреннего виртуального обмена этого токена на второй токен пула. Таким образом, сначала происходит виртуальный обмен, а далее функция ведёт себя аналогично `replenishWithTwoTokens`. Проверяется, что результат виртуального обмена и платеж пользователя имеют соотношение близкое к соотношению итоговых балансов с учётом виртуального обмена и платежа.

Замечено, что `ratioShareTokensInA` и `ratioShareTokensInB` рассчитываются с учётом комиссии на стейкинг, однако соотношение `ratioVirtualBalanceToVirtualReplenish` рассчитывается без учёта данной комиссии. Таким образом, идеальное соотношение для пользователя, когда совпадают значения `ratioShareTokensInA` и `ratioShareTokensInB`, может не пройти предварительную проверку по `slippageValueMinForReplenish` и `slippageValueMaxForReplenish`. РЕКОМЕНДУЕТСЯ учитывать комиссию на стейкинг при расчёте всех соотношений.

Замечено, что результат работы `replenishWithOneToken`, долевые токены пула, может быть сразу передан в функцию `withdraw`, которая вернёт токены пула в соответствии с текущим соотношением токенов и долей пользователя. Однако, если данный функционал представить как обмен, то данный вариант обмена через `replenishWithOneToken` и `withdraw` не содержит удержание комиссии как в функции `exchange`, что может быть использовано для обхода уплаты комиссии в пул при крупных обменах.

РЕКОМЕНДУЕТСЯ предусмотреть удержание комиссии за виртуальный обмен в функции `replenishWithOneToken`, по аналогии с `exchange`.

Замечено, что подфункция `suspendSuspicious`, которая приостанавливает работу контракта в автоматическом виде, не отправляет пользователю обратно платежи, которые могли быть получены в рамках транзакции. Хотя данный функционал корректно реализован в рамках контрактов `nsbt_usdn.ride` и `waves_eurn.ride`.

РЕКОМЕНДУЕТСЯ выделить общие части в единый код, для минимизации регрессий.

Последней проверкой является достаточность токенов на балансе в настоящий момент, для передачи их пользователю. Так как функционал пулов предполагает активное использование стейкинга протокола Neutrino, достаточное количество токенов может не оказаться на балансе контракта и они должны быть предварительно сняты со стейкинга протокола Neutrino.

Функция разбита на две части, для обмена первого токена на второй и наоборот, что безосновательно дублирует код. РЕКОМЕНДУЕТСЯ объединить смысловые части, так как суть отличия составляет только направление обмена (данная рекомендация решена в актуальном исходном коде контракта).

Верификация FLAT пулов представлена скриптом [`test-flat`](test/test-flat.php). Так как работа контракта локализована и никакие дополнительные учёты не ведутся, верификация заключается в проверке рассчитанного состояния состоянию в основной сети Waves.

Верификация проходит успешно, погрешности и отрицательные влияния округлений не обнаружены. Функция `takeIntoAccountExtraFunds` вызывается внешним обработчиком с устоявшимся значением 18 размеров minSponsoredFee, средняя частота вызовов равна раз в ~1474 блока (~раз в день) для пула `3PPH7x7iqobW5ziyiRCic19rQqKr6nPYaK1`.

Удержание двойной комиссии, например для пула `3PPH7x7iqobW5ziyiRCic19rQqKr6nPYaK1`, затрагивает ~9% обменов, в пользу пулов дополнительно собрано +23% комиссий, что можно представить как повышенную общую комиссию с 0.05% до 0.06%.

### Нюансы работы функций `exchange`

В пулах CPMM и FLAT успешный вызов функции `exchange` не гарантирован при работе в конкурентной среде, если несколько пользователей одновременно совершают обмен, то в процессе исполнения `exchange` данные, на которые рассчитывали пользователи при вызове функции, могли измениться при обработке `exchange` других пользователей.

Для повышения гарантий исполнения пользователи могут идти на риск, понижая минимальное количество ожидаемых токенов.

Так как транзакции пользователей попадают в пул неподтверждённых транзакций, они становятся публичными. Штамп времени транзакции является валидным для исполнения в сети Waves, если находится в пределах [2 часа в прошлом или 1.5 часа в будущем](https://docs.waves.tech/en/blockchain/transaction/). Получается, что пользователь, транзакция `exchange` которого не исполнилась по причине выхода баланса токенов пула из соответствующих значений, попадает в ситуацию, что его транзакция всё ещё может быть исполнена в течение 2 часов.

Данный нюанс может быть совершенно неожидан для пользователей не знакомых глубоко с принципами функционирования блокчейна Waves. Поэтому РЕКОМЕНДУЕТСЯ добавить аргумент функции, или новую функцию аналогичную `exchange`, или в работу функции `exchange` по умолчанию возможность установки явного ограничения на исполнение обмена, например, в текущем и следующем блоке, что снизит неопределённость от исполнения сразу неисполненной транзакции в будущем.

### Нюансы работы стейкинга

Как уже отмечено, функционал `exchange` и `withdraw` функций в пулах CPMM и FLAT может не отработать при отсутствии на балансе пула необходимого количества токенов, которые могут быть зарезервированы в стейкинге протокола Neutrino.

Так как стейкинг управляется внешним обработчиком, возможно возникновение ситуации, когда пользователь желает произвести крупную операцию, но получает ошибку, которая не фиксируется где-либо и видна только пользователю. Поэтому пользователь вынужден разбить крупную операцию на части, которые могут быть исполнены с учётом доступного баланса в пуле. Тогда, по мере частичного исполнения, внешний обработчик сможет отреагировать на нехватку баланса.

Реализованная схема работа со стейкингом является наиболее оптимальной в данный момент в виду ограничений языка RIDE. От команды Swop.fi получено подтверждение, что в дальнейшем с выходом новой версии RIDE, данный функционал будет автоматизирован в непосредственном вызове `exchange` и `withdraw` без участия внешнего обработчика.

### Early-birds (распределение SWOP для ранних инвесторов)

Контракт по адресу `3PJuspTjxHhEJQjMEmLM5upiGQYCtCi5LyD` с одной функцией `claimSWOP` без параметров, которая определяет текущий размер награды в токенах SWOP для вызывающего адреса и в случае успеха отправляет ему эту награду.

Список адресов с доступными наградами рассчитан вне контракта (не является предметом аудита) и записан с помощью Data транзакций до начала работы смарт-контракта. Сумма наград в этих записях равна 999999.99999115 SWOP, до начала работы на контракт произведён трансфер 1000000.00000000 SWOP в рамках инициализации контракта (транзакция `5gVX4xgeg8rQ3Kz18rcQyPFo7BpsdqyKrqQM9JetVtSm`).

Так как каждый вызов `claimSWOP` учитывает разницу с уже полученной наградой, суммарная награда в конце периода будет в точности равна числу изначально записанному в качестве награды, несмотря на округления, возникающие в промежуточных вызовах.

Весь заявленный на сайте функционал присутствует, нюансов не обнаружено.

Верификация работы контракта по адресу `3PJuspTjxHhEJQjMEmLM5upiGQYCtCi5LyD` представлена скриптом [`test-early_birds`](test/test-early_birds.php). Данный скрипт эмулирует функционал оригинального контракта и производит расчёт:
- Общей изначальной награды SWOP на основе записей Data транзакций.
- Общей суммы SWOP полученных пользователями за весь период.
- Разницу между заложенной и рассчитанной суммами SWOP.
 
Результат работы при использовании [чисел с плавающей запятой](https://en.wikipedia.org/wiki/Floating-point_arithmetic) не имеет расхождений с ожиданием.

```log
2021.05.10 17:05:04    INFO: users_total_share = 999999.99999115
2021.05.10 17:05:04    INFO: users_total_claimed = 999999.99999115
2021.05.10 17:05:04    INFO: diff = 0.00000000
```

Результат работы при использовании целых чисел в функции [fraction](https://docs.waves.tech/ru/ride/functions/built-in-functions/math-functions#fraction) (соответствует текущей точности в блокчейне Waves).

```log
2021.05.10 17:37:49    INFO: users_total_share = 999999.99999115
2021.05.10 17:37:49    INFO: users_total_claimed = 999999.99999115
2021.05.10 17:37:49    INFO: diff = 0.00000000
```

Расчёт полностью соответствует ожиданиям, верификация является успешной.

### Governance (распределение SWOP за стейкинг)

Контракт по адресу `3PLHVWCqA9DJPDbadUofTohnCULLauiDWhS` с функциями `airDrop`, `lockSWOP`, `withdrawSWOP`, `claimAndWithdrawSWOP`, `claimAndStakeSWOP`, `updateWeights`, `shutdown`, `activate`.

Функции `activate`/`shutdown` могут быть вызваны только администраторами и устанавливают ключ `keyActive` в значение, которое разрешает/запрещает вызов остальных функций соответственно.

Функции `lockSWOP`, `withdrawSWOP`, `claimAndWithdrawSWOP` и `claimAndStakeSWOP` обеспечивают учёт стейкинга и получение награды за него. Расчёт долей от общей награды считается при каждом вызове данных функций в ключе `keyUserLastInterest`.

Общая награда формируется в функции `airDrop` в ключе `keyLastInterest` как отношение награды к общим средствам в стейкинге.

Таким образом, награда пользователей считается как разница между текущим значением `keyLastInterest` и последним значением `keyUserLastInterest`, умноженная на размер токенов пользователя в стейкинге. После этого `keyUserLastInterest` фиксируется в текущее значение `keyLastInterest`.

Так как расчёт награды происходит каждый раз, непосредственное негативное влияние может быть оказано округлением в функции `fraction` при частом вызове функций пользователем. Но, как показывает верификация (см. ниже), это влияние не является существенным.

Функция `withdrawSWOP` также учитывает средства, находящиеся в голосовании, таким образом, чтобы вывести ранее введённые средства и награды в полном объёме, необходимо освободить их в Voting контракте в функции `votePoolWeight`. Данное ограничение влияет только на вывод, награда продолжает рассчитываться от полного объёма пользовательских средств.

Функция `updateWeights` записывает новые значения доли наград для пулов. Функция может быть вызвана от имени администраторов, в том числе локальных (`adminPubKeyStartStop` и `adminPubKeyWallet`).

Данная функция решает некоторые проблемы, которые возникали в первых версиях смены долей наград для пулов (подробнее см. верификацию Farming), проверяет, что сумма долей равняется 100% и что смена наград происходит в будущем относительно текущей высоты.

Однако, отсутствует проверка на совпадение нового значения по ключу `keyRewardPoolFractionPrevious` с текущим изменяемым `keyRewardPoolFractionCurrent`, в чём уже происходили ошибки ранее. И отсутствует связь с контрактом Voting.

РЕКОМЕНДУЕТСЯ добавить проверки совпадения прошлого значения награды с бывшим текущим и проверять новые доли наград с голосами пользователей в Voting контракте.

Верификация работы контракта по адресу `3PLHVWCqA9DJPDbadUofTohnCULLauiDWhS` представлена скриптом [`test-governance`](test/test-governance.php). Данный скрипт эмулирует функционал оригинального контракта и производит расчёт:
- Общей суммы токенов SWOP в стейкинге.
- Общей суммы токенов SWOP на учёте контракта.
- Общей суммы токенов SWOP всех пользователей (включая все награды).
- Разницу между суммой SWOP пользователей и контрактом.

Результат работы при использовании [чисел с плавающей запятой](https://en.wikipedia.org/wiki/Floating-point_arithmetic) не имеет расхождений с ожиданием.

```log
2021.05.10 15:43:36    INFO: 387373.34068475
2021.05.10 15:43:36    INFO: 390137.62330409
2021.05.10 15:43:36    INFO: 390137.62330409
2021.05.10 15:43:36    INFO: 0.00000000
```

Результат работы при использовании целых чисел в функции [fraction](https://docs.waves.tech/ru/ride/functions/built-in-functions/math-functions#fraction) (соответствует текущей точности в блокчейне Waves) имеет расхождение около 0.004%.

```log
2021.05.10 15:43:30    INFO: 387369.95550148
2021.05.10 15:43:30    INFO: 390135.82677428
2021.05.10 15:43:30    INFO: 390133.90819713
2021.05.10 15:43:30    INFO: 1.91857715
```

В это же время (на момент транзакции `2N4ZJooWPCRJkV8DhSmLpxde7P6zbquJ2Wi1V6HVvLAH`) в основной сети Waves на соответствующем контракте находится `390135.80534807` токенов SWOP, что перекрывает значение `390133.90819713`, если бы все пользователи решили вывести все средства с наградами.

Верификация является успешной.

Первая версия контракта содержала ошибку, что было скорректировано полным перерасчётом всех участвующих в работе ключей и их обновлением с помощью Data транзакций, произведённых администраторами. Данная верификация помогла подтвердить корректность значений обновлённых ключей. В настоящий момент значения ключей полностью совпадают с ключами верификации.

### Governance-LP (сбор и конвертация комиссий в SWOP для Governance)

Контракт по адресу `3P6J84oH51DzY6xk2mT5TheXRbrCwBMxonp` без внешних функций. Функционал контракта является разрешающим определённые действия от имени адреса контракта при соблюдении определённых условий, при этом локальным администратором данных действий считается публичный ключ `Czn4yoAuUZCVCLJDRfskn8URfkwpknwBTZDbs1wFrY7h` (соответствующий адресу `3PPupsBVHgDXaRhyMbkTxminzAotp8AMsr6`).

Разрешёнными считаются:
- Вызов функции `exchange` в любом обменном пуле зарегистрированным в Pools (реестре пулов).
- Вызов функции `airDrop` и `updateWeights` в Governance (распределение SWOP за стейкинг).
- Вызов функции `updatePoolInterest` в Farming (награда за стейкинг токенов обменных пулов).
 
Дальнейший регламент вызов определяется внешним обработчиком. РЕКОМЕНДУЕТСЯ предоставить исходные коды внешнего обработчика для проведения анализа его работы.

Рекомендации по размеру комиссии даны в разделе Безопасность > Общее.

Верификация работы контракта `3P6J84oH51DzY6xk2mT5TheXRbrCwBMxonp` представлена скриптом [test-governance_lp](test/test-governance_lp.php), который учитывает все поступления в рамках комиссионных выплат с обменных пулов, делает расчёт обменов, затрат на комиссии вызовов транзакций, выплаты в Governance функцией `airDrop`, учитывает вызовы `updateWeights` и `updatePoolInterest`.

По результату (на момент транзакции `GRtSotTKorHMekjLUkipo3fNLidZG71RGvsvHRVPd4gQ`) формируется выдача, в которой представлены все полученные средства, потраченные на обмен в SWOP и комиссии, общее количество отправленных токенов SWOP, средний размер и частота выплат.

```log
2021.05.11 09:04:55    INFO: updateWeights (2513318:2513318)
2021.05.11 09:04:56    INFO: updateWeights (2523445:10127)
2021.05.11 09:04:57    INFO: updateWeights (2533572:10127)
2021.05.11 09:04:57    INFO: updateWeights (2543710:10138)
2021.05.11 09:04:58    INFO: updateWeights (2553887:10177)
2021.05.11 09:04:59    INFO: updateWeights (2563991:10104)
2021.05.11 09:05:00    INFO: updateWeights (2574093:10102)
2021.05.11 09:05:01    INFO: updateWeights (2584195:10102)
2021.05.11 09:05:01 SUCCESS: dAppReproduce() done
2021.05.11 09:05:01    INFO: total plus:
2021.05.11 09:05:01    INFO: |- 9026.89193923 WAVES
2021.05.11 09:05:01    INFO: |- 409973.003691 USD-N
2021.05.11 09:05:01    INFO: |- 9614.966839 USDT
2021.05.11 09:05:01    INFO: |- 1.16836061 WBTC
2021.05.11 09:05:01    INFO: |- 1330.839868 NSBT
2021.05.11 09:05:01    INFO: |- 2065.55 WavesCommunity
2021.05.11 09:05:01    INFO: |- 12019.42145014 WEST
2021.05.11 09:05:01    INFO: |- 0.00920272 sWAVES
2021.05.11 09:05:01    INFO: |- 2178.790796 Neutrino EUR
2021.05.11 09:05:01    INFO: |- 2558.049003 USDTLP
2021.05.11 09:05:01    INFO: |- 17611.30682622 SWOP
2021.05.11 09:05:01    INFO: |- 4.49876329 WETH
2021.05.11 09:05:01    INFO: |- 2594.484477 USD Coin
2021.05.11 09:05:01    INFO: |- 1266.748861 USDCLP
2021.05.11 09:05:01    INFO: |- 1098.65332541 Curve DAO Token
2021.05.11 09:05:01    INFO: |- 165.04413677 Freeliquid
2021.05.11 09:05:01    INFO: |- 218660.02104438 SIGN
2021.05.11 09:05:01    INFO: total minus:
2021.05.11 09:05:01    INFO: |- 9016.96393923 WAVES
2021.05.11 09:05:01    INFO: |- 1.16836061 WBTC
2021.05.11 09:05:01    INFO: |- 1330.817395 NSBT
2021.05.11 09:05:01    INFO: |- 2178.790796 Neutrino EUR
2021.05.11 09:05:01    INFO: |- 9614.491952 USDT
2021.05.11 09:05:01    INFO: |- 2558.022994 USDTLP
2021.05.11 09:05:01    INFO: |- 12019.42145014 WEST
2021.05.11 09:05:01    INFO: |- 2065.55 WavesCommunity
2021.05.11 09:05:01    INFO: |- 409951.257513 USD-N
2021.05.11 09:05:01    INFO: |- 17611.30682622 SWOP
2021.05.11 09:05:01    INFO: |- 4.49876329 WETH
2021.05.11 09:05:01    INFO: |- 1266.471992 USDCLP
2021.05.11 09:05:01    INFO: |- 2587.923330 USD Coin
2021.05.11 09:05:01    INFO: |- 1098.65332541 Curve DAO Token
2021.05.11 09:05:01    INFO: |- 218660.02104438 SIGN
2021.05.11 09:05:01    INFO: |- 164.44810538 Freeliquid
2021.05.11 09:05:01    INFO: final balance:
2021.05.11 09:05:01    INFO: |- 9.92800000 WAVES
2021.05.11 09:05:01    INFO: |- 21.746178 USD-N
2021.05.11 09:05:01    INFO: |- 0.474887 USDT
2021.05.11 09:05:01    INFO: |- 0.00000000 WBTC
2021.05.11 09:05:01    INFO: |- 0.022473 NSBT
2021.05.11 09:05:01    INFO: |- 0.00 WavesCommunity
2021.05.11 09:05:01    INFO: |- 0.00000000 WEST
2021.05.11 09:05:01    INFO: |- 0.00920272 sWAVES
2021.05.11 09:05:01    INFO: |- 0.000000 Neutrino EUR
2021.05.11 09:05:01    INFO: |- 0.026009 USDTLP
2021.05.11 09:05:01    INFO: |- 0.00000000 SWOP
2021.05.11 09:05:01    INFO: |- 0.00000000 WETH
2021.05.11 09:05:01    INFO: |- 6.561147 USD Coin
2021.05.11 09:05:01    INFO: |- 0.276869 USDCLP
2021.05.11 09:05:01    INFO: |- 0.00000000 Curve DAO Token
2021.05.11 09:05:01    INFO: |- 0.59603139 Freeliquid
2021.05.11 09:05:01    INFO: |- 0.00000000 SIGN
2021.05.11 09:05:01    INFO: totalAirDropped = 16633.42648856 SWOP
2021.05.11 09:05:01    INFO: mean airDrop = 7.50723814 SWOP
2021.05.11 09:05:01    INFO: mean period = 61.16 blocks
```

Все функции вызываются с ожидаемой частотой, функция коррекции инварианта при отсутствии транзакций в пуле `updatePoolInterest` не вызывалась.

Баланс адреса `3P6J84oH51DzY6xk2mT5TheXRbrCwBMxonp` на момент работы скрипта совпадает с рассчитанным балансом, что подтверждает целевой расход средств.

Верификация считается успешной, так как удовлетворяет основным заявленным принципам работы Swop.fi, изложенным на сайте, а именно конвертации входящих комиссий в SWOP и их распределение участникам стейкинга SWOP в контракте Governance.

### Farming (награда за стейкинг токенов обменных пулов)

Контракт по адресу `3P73HDkPqG15nLXevjCbmXtazHYTZbpPoPw` с функциями `init`, `initPoolShareFarming`, `updatePoolInterest`, `lockShareTokens`, `withdrawShareTokens`, `claim`.

Функция `init` вызывается однократно, она выпускает и фиксирует основной токен проекта SWOP, идентификатор которого записывается в ключе переменной `keySWOPid`. Размер выпущенных токенов фиксирован и отправляется в рамках функции на адрес из аргумента вызова функции (данный функционал закомментирован в текущей версии скрипта). В данном случае на адрес Early-birds в соответствии с заявленным распределением 1000000 SWOP ранним инвесторам (см. функционал и верификацию Early-birds).

Функция `init` защищена от повторного вызова, но не содержит ограничений на адрес вызова, что может привести к нецелевому вызову данной функции в ходе инициализации аналогичного проекта на других адресах. РЕКОМЕНДУЕТСЯ добавить ограничение на вызов данной функции администратором.

Функция `initPoolShareFarming` вызывается каждый раз при добавлении пула в учёт фарминга. Функция может быть вызвана только от имени контракта, а значит требуются подписи двух администраторов. Функция инициализирует нулями ключи пула из аргумента `keyShareTokensLocked` и `keyLastInterest`. Без инициализации данных ключей работа с пулом будет невозможна.

Функции `lockShareTokens`, `withdrawShareTokens` и `claim` обеспечивают учёт стейкинга токенов пула и получение награды за него. Расчёт долей от общей награды считается при каждом вызове данных функций в ключе `keyUserLastInterest`.

В отличие от Governance, где награда формировалась только в функции `airDrop`, в контракте Farming награда формируется при росте высоты блокчейна, поэтому расчёт награды производится в каждом вызове рассматриваемых функций и записывается в ключ пула `keyLastInterest`.

Таким образом, награда пользователей считается как разница между текущим значением `keyLastInterest` и последним значением `keyUserLastInterest`, умноженная на размер токенов пользователя в стейкинге. После этого `keyUserLastInterest` фиксируется в текущее значение `keyLastInterest`.

Так как расчёт награды происходит каждый раз, непосредственное негативное влияние может быть оказано округлением в функции `fraction` при частом вызове функций пользователем. Но как показывает верификация (см. ниже) это влияние не является существенным.

Расчёт награды является динамическим, так как может меняться в зависимости от состояния ключей в контракте Governance, которые устанавливаются функцией `updateWeights`.

На текущий момент ключи `keyTotalRewardPerBlockCurrent` и `keyTotalRewardPerBlockPrevious` зафиксированы администраторами в Data транзакции (`CiA8tvkzCLbVYGfhLgkEBRhuHg5ajJc6c55TGEr4SQxY`) и соответствуют заявленной величине награды в 1000000 SWOP в год, а именно значение 189751395, что при скорости 1440 соответствует (100000000000000 / 189751395 / 1440 = ) ~366 дней.

Ключи `keyRewardUpdateHeight` и ключи для каждого пула `keyRewardPoolFractionCurrent` и `keyRewardPoolFractionPrevious` меняются с каждым вызовом `updateWeight` и начинаются учитываться в следующем вызове функций Farming.

Текущий подход продолжает содержать недостаток, при котором отсутствие вызовов функций `lockShareTokens`, `withdrawShareTokens` и `claim` для пула в период действия `keyRewardPoolFractionCurrent` может привести к некорректному расчёту `keyLastInterest`.

РЕКОМЕНДУЕТСЯ переход на схему расчёта, учитывающую более 2 периодов.

Верификация работы контракта `3P73HDkPqG15nLXevjCbmXtazHYTZbpPoPw` представлена скриптами 1) [test-farming_v1](test/test-farming_v1.php), который учитывает регистрацию пулов, смену награды пулов, стейкинг и награды пользователей, в зависимости от текущей награды до момента транзакции перехода на текущие ключи наград `5TjBrivfmEDnMr5hLDnwNLDs63dim8Y1jM8Zc59Zd9ta`, и 2) [test-farming_v2](test/test-farming_v2.php), который начинает свой учёт с завершения работы скрипта `test-farming_v1` и учитывает регистрацию пулов, смену награды пулов, стейкинг и награды пользователей в текущей версии контракта.

В результате работы формируется база, по которой делаются два независимых расчёта, отдельно считаются награды сгенерированные пулами безотносительно пользователей и суммарный объём полученных и неполученных наград.

Совпадение данных значений говорит о корректности логики расчёта наград на всех этапах.

При верификации данного контракта возникли сложности с интерпретацией результатов, так как логика работы ранних версий контракта не была корректной, а именно присутствовали 2 ключевые проблемы: 1) отсутствовал промежуточный период смены величины награды, смена происходила сразу после установки новых значений, а новые значения устанавливали высоту смены награды в прошлом и 2) награды для пулов устанавливались вручную администраторами с помощью Data транзакций, которые не верифицировались каким-либо кодом контрактов, поэтому содержали ошибки, такие как 1) слишком частая смена с отсутствием вызовов в промежутке и 2) некорректные значения предыдущей награды за блок, не равной прошлой текущей награде.

Данные проблемы привели к тому, что данный контракт невозможно верифицировать на данных основной сети без их предварительной коррекции.

По умолчанию коррекция включена, но может быть отключена ключом `WFIX=0`.

При расчёте с коррекцией верификация показывает валидность текущей логики, однако существующие раннее ошибки уже внесли свой вклад в расчёт значений `keyLastInterest` и `keyUserLastInterest`.

Таким образом, не существует способа одновременно доказать валидность логики и корректность расчёта с полным совпадением рассчитанных значений с данными в основной сети Waves для данного контракта.

Поэтому верификация разделена на 2 этапа: 1) верифицирует работу ранней версии контракта 2) верифицирует работу текущей версии.

Результат работы `test-farming_v1` до транзакции `5TjBrivfmEDnMr5hLDnwNLDs63dim8Y1jM8Zc59Zd9ta` при использовании [чисел с плавающей запятой](https://en.wikipedia.org/wiki/Floating-point_arithmetic) полностью соответствует ожиданиям, за исключением пула `3PK7Xe5BiedRyxHLuMQx5ey9riUQqvUths2`, в котором произошёл перерасчёт с перекрытием наград при отсутствии транзакций за период, описанный ранее, что явилось причиной несовпадения балансов в пользу одного участника фарминга.

```log
2021.05.14 08:15:55    INFO: 3PHaNgomBkrvEL2QnuJarQVJa71wjw9qiqG: 15207.22180181 === 15207.22180180 (0.00000000)
2021.05.14 08:15:55    INFO: 3PACj2DLTw3uUhsUmT98zHU5M4hPufbHKav: 9033.19500857 === 9033.19500822 (0.00000034)
2021.05.14 08:15:55    INFO: 3P8FVZgAJUAq32UEZtTw84qS4zLqEREiEiP: 11528.72691823 === 11528.72691786 (0.00000036)
2021.05.14 08:15:55    INFO: 3P2V63Xd6BviDkeMzxhUw2SJyojByRz8a8m: 10291.09990831 === 10291.09990830 (0.00000000)
2021.05.14 08:15:55    INFO: 3PMDFxmG9uXAbuQgiNogZCBQASvCHt1Mdar: 557.33720094 === 557.33720032 (0.00000061)
2021.05.14 08:15:55    INFO: 3PPH7x7iqobW5ziyiRCic19rQqKr6nPYaK1: 14367.69467757 === 14367.69467724 (0.00000032)
2021.05.14 08:15:55    INFO: 3P6DLdJTP2EySq9MFdJu6beUevrQd2sVVBh: 3228.33477040 === 3228.33477039 (0.00000000)
2021.05.14 08:15:55    INFO: 3PK7Xe5BiedRyxHLuMQx5ey9riUQqvUths2: 2229.34873433 === 2649.41618876 (-420.06745443)
2021.05.14 08:15:55    INFO: 3PDWi8hjQJjXhyTpeaiEYfFKWBd1iC4udfF: 5748.26497227 === 5748.26497226 (0.00000000)
2021.05.14 08:15:55    INFO: 3P27S9V36kw2McjWRZ37AxTx8iwkd7HXw6W: 19405.00424771 === 19405.00424738 (0.00000032)
2021.05.14 08:15:55    INFO: 3PNEC4YKqZiMMytFrYRVtpW2ujvi3aGXRPm: 8641.82517407 === 8641.82517407 (0.00000000)
2021.05.14 08:15:55    INFO: 3PNi1BJendWYYe2CRnqpfLoYxUZ6UTcx3LF: 9528.55977044 === 9528.55977010 (0.00000034)
2021.05.14 08:15:55    INFO: 3PNr615DPhHpCJSq1atHYKKnoauWGHsYWBP: 1606.35545581 === 1606.35545581 (0.00000000)
2021.05.14 08:15:55    INFO: 3P9o2H6G5d2xXBTfBEwjzHc16RLSZLFLQjp: 962.79847675 === 962.79847686 (-0.00000011)

2021.05.14 08:15:55    INFO: TOTAL: 112335.76711721 === 112755.83456944 (-420.06745223)
```

В связи с указанными проблемами в ранних версиях контракта скрипт `test-farming_v2` работает по принципу разницы снимков балансов на этапах вызова функции `updateWeight`.

Результат работы `test-farming_v2` при использовании [чисел с плавающей запятой](https://en.wikipedia.org/wiki/Floating-point_arithmetic) полностью соответствует ожиданиям.

```log
2021.05.13 19:29:36    INFO: 3PHaNgomBkrvEL2QnuJarQVJa71wjw9qiqG: 3712.31231792 === 3712.31231792 (0.00000000)
2021.05.13 19:29:36    INFO: 3P2V63Xd6BviDkeMzxhUw2SJyojByRz8a8m: 458.77216823 === 458.77216823 (0.00000000)
2021.05.13 19:29:36    INFO: 3P8FVZgAJUAq32UEZtTw84qS4zLqEREiEiP: 884.93378039 === 884.93378039 (0.00000000)
2021.05.13 19:29:36    INFO: 3PPH7x7iqobW5ziyiRCic19rQqKr6nPYaK1: 6428.17570436 === 6428.17570436 (0.00000000)
2021.05.13 19:29:36    INFO: 3P6DLdJTP2EySq9MFdJu6beUevrQd2sVVBh: 439.76797570 === 439.76797570 (0.00000000)
2021.05.13 19:29:36    INFO: 3PMDFxmG9uXAbuQgiNogZCBQASvCHt1Mdar: 293.29923307 === 293.29923307 (0.00000000)
2021.05.13 19:29:36    INFO: 3PACj2DLTw3uUhsUmT98zHU5M4hPufbHKav: 572.44991224 === 572.44991224 (0.00000000)
2021.05.13 19:29:36    INFO: 3PDWi8hjQJjXhyTpeaiEYfFKWBd1iC4udfF: 85.62947621 === 85.62947621 (0.00000000)
2021.05.13 19:29:36    INFO: 3PK7Xe5BiedRyxHLuMQx5ey9riUQqvUths2: 479.93347967 === 479.93347967 (0.00000000)
2021.05.13 19:29:36    INFO: 3P27S9V36kw2McjWRZ37AxTx8iwkd7HXw6W: 2356.95117924 === 2356.95117924 (0.00000000)
2021.05.13 19:29:36    INFO: 3PNEC4YKqZiMMytFrYRVtpW2ujvi3aGXRPm: 333.56171747 === 333.56171747 (0.00000000)
2021.05.13 19:29:36    INFO: 3PNi1BJendWYYe2CRnqpfLoYxUZ6UTcx3LF: 1131.09730363 === 1131.09730363 (0.00000000)
2021.05.13 19:29:36    INFO: 3PNr615DPhHpCJSq1atHYKKnoauWGHsYWBP: 113.96708620 === 113.96708620 (0.00000000)
2021.05.13 19:29:36    INFO: 3P9o2H6G5d2xXBTfBEwjzHc16RLSZLFLQjp: 243.11972147 === 243.11972162 (-0.00000014)
2021.05.13 19:29:36    INFO: 3P4Ftyud3U3xnuR8sTc1RvV4iQD62TcKndy: 877.41840214 === 877.41840214 (0.00000000)
2021.05.13 19:29:36    INFO: 3PKy2mZqnvT2EtpwDim9Mgs6YvCRe4s85nX: 757.29646488 === 757.29646488 (0.00000000)
2021.05.13 19:29:36    INFO: SNAPSHOT (2574093..2584195): 19168.68592290 === 19168.68592304 (-0.00000014)

2021.05.13 19:29:36    INFO: TOTAL (2513318..2588950): 143512.77506640 === 143512.77506599 (0.00000040)
```

Результат работы `test-farming_v2` при использовании целых чисел в функции [fraction](https://docs.waves.tech/ru/ride/functions/built-in-functions/math-functions#fraction) (соответствует текущей точности в блокчейне Waves) имеет расхождение около 0.4%.

```log
2021.05.13 19:31:35    INFO: 3PHaNgomBkrvEL2QnuJarQVJa71wjw9qiqG: 3712.31223160 === 3708.67344200 (3.63878960)
2021.05.13 19:31:35    INFO: 3P2V63Xd6BviDkeMzxhUw2SJyojByRz8a8m: 458.77209920 === 458.55583408 (0.21626512)
2021.05.13 19:31:35    INFO: 3P8FVZgAJUAq32UEZtTw84qS4zLqEREiEiP: 884.93369498 === 884.93080070 (0.00289428)
2021.05.13 19:31:35    INFO: 3PPH7x7iqobW5ziyiRCic19rQqKr6nPYaK1: 6428.17569384 === 6332.73987577 (95.43581807)
2021.05.13 19:31:35    INFO: 3P6DLdJTP2EySq9MFdJu6beUevrQd2sVVBh: 439.76793598 === 439.26011159 (0.50782439)
2021.05.13 19:31:35    INFO: 3PMDFxmG9uXAbuQgiNogZCBQASvCHt1Mdar: 293.29917912 === 292.90962781 (0.38955131)
2021.05.13 19:31:35    INFO: 3PACj2DLTw3uUhsUmT98zHU5M4hPufbHKav: 572.44988124 === 572.44656032 (0.00332092)
2021.05.13 19:31:35    INFO: 3PDWi8hjQJjXhyTpeaiEYfFKWBd1iC4udfF: 85.62939824 === 85.17197389 (0.45742435)
2021.05.13 19:31:35    INFO: 3PK7Xe5BiedRyxHLuMQx5ey9riUQqvUths2: 479.93345620 === 479.86192142 (0.07153478)
2021.05.13 19:31:35    INFO: 3P27S9V36kw2McjWRZ37AxTx8iwkd7HXw6W: 2356.95116284 === 2354.41363225 (2.53753059)
2021.05.13 19:31:35    INFO: 3PNEC4YKqZiMMytFrYRVtpW2ujvi3aGXRPm: 333.56166700 === 333.55389593 (0.00777107)
2021.05.13 19:31:35    INFO: 3PNi1BJendWYYe2CRnqpfLoYxUZ6UTcx3LF: 1131.09726266 === 1126.46310838 (4.63415428)
2021.05.13 19:31:35    INFO: 3PNr615DPhHpCJSq1atHYKKnoauWGHsYWBP: 113.96707234 === 113.56244949 (0.40462285)
2021.05.13 19:31:35    INFO: 3P9o2H6G5d2xXBTfBEwjzHc16RLSZLFLQjp: 243.11971024 === 243.01434278 (0.10536746)
2021.05.13 19:31:35    INFO: 3P4Ftyud3U3xnuR8sTc1RvV4iQD62TcKndy: 877.41837894 === 854.57190817 (22.84647077)
2021.05.13 19:31:35    INFO: 3PKy2mZqnvT2EtpwDim9Mgs6YvCRe4s85nX: 757.29639104 === 757.08193395 (0.21445709)
2021.05.13 19:31:35    INFO: SNAPSHOT (2574093..2584195): 19168.68521546 === 19037.21141853 (131.47379693)

2021.05.13 19:31:35    INFO: TOTAL (2513318..2588950): 143512.76927241 === 142914.39338612 (598.37588629)
```

Принимая во внимание, что контракт Farming самостоятельно не накапливает токены SWOP, а выпускает их по мере обращения пользователей, данное расхождение не имеет свойства накапливающейся ошибки, а имеет влияние только на заявленную эмиссию в 1 миллион токенов SWOP в год, которая может быть скорректирована в большую сторону с учётом процента расхождения.

Верификация является успешной.

### Pools (реестр пулов)

Контракт по адресу `3PEbqViERCoKnmcSULh6n2aiMvUdSQdCsom` с функциями `addPool` и `renamePool`. Функции могут быть вызваны только от имени контракта, что соответственно требует 2 подписей администраторов.

Функция `addPool` регистрирует адрес и название в базе данных пулов. Делаются три записи:
- Индекс пула, который увеличивается при каждом вызове.
- Ключ с адресом пула и названием в значении.
- И запись по ключу в `keyPoolsListName` с адресами всех добавленных пулов, разделённых запятыми.
 
Функция `renamePool` позволяет изменить название пула.

Название пула проверяется на соответствие двум строкам, разделённым знаком `_`.

Функционал данного контракта не очевиден, так как заложенный функционал или избыточен и не планируется в использовании, так как индекс и полный список пулов не используются в других контрактах, или функционал полноценного менеджмента, не только по переименованию, но и удалению, отсутствует.

Также функционал инициализации работы с новыми пулами присутствует в других контрактах, например функция `initPoolShareFarming` в контракте Farming.

Также ведение информации о наградах сосредоточено в другом контракте Governance, информация обновляется функцией `updateWeights`.

РЕКОМЕНДУЕТСЯ сосредоточить информацию о пулах в одном месте и унифицировать логику инициализации/добавления/исключения пулов из работы системы.

Верификация работы контракта по адресу `3PEbqViERCoKnmcSULh6n2aiMvUdSQdCsom` представлена скриптом [`test-pools`](test/test-pools.php). Данный скрипт эмулирует функционал оригинального контракта и производит проверку заложенной логики относительно обработки транзакций в основной сети Waves.

Верификация проходит успешно, разницы в логике и практической работе не выявлено.

### Voting (голосование)

Контракт по адресу `3PQZWxShKGRgBN1qoJw6B4s9YWS9FneZTPg` с одной функцией `votePoolWeight`.

Функция `votePoolWeight` вызывается пользователями Governance, имеющих положительный стейкинг баланс. Аргументами являются списки пулов и голоса за них, данный прототип сохранился от первой версии функции. В текущей версии не реализован функционал работы с более чем одной записью в списке, ранее такая возможность присутствовала. Вероятно, этот функционал будет доработан в следующих версиях. В рамках текущего анализа, считаем, что вызов функции может изменить учёт только для одного пула.

Текущий вариант функции `votePoolWeight` имеет две основные логические ветви поведения: 1) пользователь увеличивает количество голосов за пул и 2) пользователь уменьшает количество голосов за пул.

В текущей версии контракта введено понятие коэффициента веса голоса, который в течение времени `durationFullVotePower` (~1 день) сохраняет вес SWOP в голосе 1 к 1 и линейно уменьшается до значения `minVotePower` (10 к 1) в конце периода голосования.

Записи результатов учитываются в 3 структурах:
- Структура пользователя для каждого пула содержит: 1) количество SWOP в голосовании 2) вес голосов с учётом коэффициента 3) текущий период 4) количество замороженных SWOP в текущем периоде.
- Структура пула содержит: 1) количество SWOP отданных за пул 2) вес голосов с учётом коэффициента 3) номер текущего периода.
- Общая структура содержит: 1) общее количество SWOP в голосовании 2) вес голосов с учётом коэффициента 3) номер текущего периода.

При увеличении количества голосов за пул учитывается коэфициент веса голоса. При снятии голосов используется снятие доли голосов. Такая разница может быть не очевидна для пользователя, который проголосовал в начале периода, в конце периода и после этого решил забрать часть голосов, так как в случае снятия голосов все токены будут иметь одинаковый вес.

Хотя в коде голосования не выявлены ошибки в логике, код уменьшения количества голосов имеет необоснованно сложную и неочевидную реализацию. РЕКОМЕНДУЕТСЯ провести рефакторинг кода уменьшения количества голосов для минимизации ветвления и облегчения понимания.

[`a68796c2073c623b0d1d6f7185f52ec75be9a7fa`: voting.ride (L171-L179)](https://github.com/swopfi/swopfi-smart-contracts/blob/a68796c2073c623b0d1d6f7185f52ec75be9a7fa/dApps/SWOP/voting.ride#L171-L179):

```scala
        let userPoolFreezeSWOPnew = if userPoolVotePeriod == currPeriod then userPoolFreezeSWOP else userPoolVoteSWOP
        let userPoolFreezeSWOP2 = min([userPoolFreezeSWOP, userPoolVoteSWOP])
        let userPoolFreezeSWOPnew2 = min([userPoolFreezeSWOPnew, userPoolVoteSWOPnew])
        let userPoolActiveVoteSWOPnew = userPoolFreezeSWOPnew2 + if userPoolVoteSWOP - userPoolFreezeSWOP == 0 then 0 
            else fraction(userPoolActiveVoteSWOP - userPoolFreezeSWOP,userPoolVoteSWOPnew - userPoolFreezeSWOPnew2, userPoolVoteSWOP-userPoolFreezeSWOP)
        let userPoolActiveVoteDiff = userPoolActiveVoteSWOPnew - if userPoolVotePeriod == currPeriod then userPoolActiveVoteSWOP else userPoolVoteSWOP
        let newUnvoted = max([0, removePoolVote - if userPoolVotePeriod == currPeriod then userPoolVoteSWOP - userPoolFreezeSWOP2 else 0])
        let userUnvotedNew = newUnvoted + if userUnvotedPeriod == currPeriod then userUnvoted else 0 
        let userUnvotedPeriodNew = if newUnvoted > 0 then currPeriod else userUnvotedPeriod
```

Верификация работы контракта по адресу `3PQZWxShKGRgBN1qoJw6B4s9YWS9FneZTPg` представлена скриптом [`test-voting`](test/test-voting.php). Данный скрипт эмулирует функционал оригинального контракта и производит проверку заложенной логики вызовов `updateWeights`.

Верификация состоит в проверке учёта голосов и соответствие установки долей наград в функции `updateWeight` контракта Governance долям на базе значений ключей `kPoolVoteSWOP` и `kTotalVoteSWOP` в первой версии контракта и значений ключей `kPoolStruc` и `kTotalStruc` в текущей версии.

```log
2021.05.13 19:45:53    INFO: updateWeigth at 6LBwYRt8eRxQW5MLnFpzxmzQdQx7LaVM19NCg6h46Ydy
2021.05.13 19:45:53    INFO: updateWeigth at DiDWymP49xFj7qChAn8MiERvEecUZWcQK8Hnv2ZJPcDB
2021.05.13 19:45:54    INFO: updateWeigth at 9KZFMcpbA8kqJDvsyZkzKkjWdAuHGZ9GV3sThLhdanPt
2021.05.13 19:45:54    INFO: updateWeigth at 5Qrtx7fwVNBZjxiPY1kvNz1viSNPEPdTcToRRqUoHQC7
2021.05.13 19:45:54    INFO: updateWeigth at G2FAjAUZE6p1M6Tb2ashELagLUSGm2RyoMsnGUoUxGQp
2021.05.13 19:45:54 WARNING: 3P6DLdJTP2EySq9MFdJu6beUevrQd2sVVBh: 43221064 !== 43221062
2021.05.13 19:45:54    INFO: updateWeigth at 5nrCviH5bFPGQ26F4tygB2aG5kbmeDGuEy7E8BAMMg5T
2021.05.13 19:45:54    INFO: updateWeigth at 483oGqcwuHa8S3YsNvDrWx9FghupZMpcfVkt25EoL7MV
2021.05.13 19:45:54    INFO: updateWeigth at HEThD2ngcx2qEn8TS2ygu6YJzRbW5QCMMcP9PxFDSvwW
```

Верификация проходит успешно, максимальная погрешность установленной и рассчитанной доли ~0.00001%.

## Выводы

Весь заявленный на официальном сайте функционал присутствует и работает согласно заявленной логике. На момент проведения аудита все выявленные ошибки в функционале были оперативно исправлены. Критических уязвимостей и ошибок по окончанию аудита не обнаружено.

На момент завершения аудита исправлена в исходном коде, но остаётся в текущей действующей версии контрактов пулов FLAT ошибка со снятием двойной комиссии за обмен при непопадании расчёта в `estimatedAmountToReceive` (обновление 26 мая 2021: ошибка полностью исправлена в коде и установленных контрактах).

Верификация полностью подтверждает работу всех текущих контрактов с точностью потерь в округлении до целых чисел. Текущая версия контракта Farming полностью проходит верификацию при использовании метода сравнения промежуточных снимков балансов. Ранние версии контракта Farming и его непосредственная работа в основной сети Waves содержали ошибки в логике, которые повлияли на повышенную эмиссию для некоторых пользователей, не превышающую 0.17% общей эмиссии на момент аудита.

Основной функционал проекта (обмены, ликвидность, стейкинг, фарминг) полностью децентрализован и не требует обслуживания на продолжительном промежутке времени.

Существующая зависимость от внешних обработчиков событий в работе стейкинга, обмена комиссий и распределения SWOP, фиксации голосования, хотя не имеют отрицательного влияния на работу системы при своей корректной работе (что подтверждено в рамках верификации работы контрактов), однако они ухудшают децентрализованные свойства контрактов. Данная зависимость от внешних обработчиков вероятно имеет 2 причины: 1) отсутствие необходимого функционала языка RIDE, например вызовов функций в других контрактах, и 2) переусложнение логики при попытке имплементации функционала в текущей (4) версии языка RIDE. РЕКОМЕНДУЕТСЯ нивелировать все внешние зависимости для полной децентрализации проекта по мере выхода новых версий языка RIDE.

Рекомендации данные в рамках аудита не являются обязательными к исполнению, но должны быть приняты во внимание и тщательно взвешены, прежде чем будет принято решение не учитывать их в следующих версия проекта.
